<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="这是一篇转载，点击查看原文链接。\n">
<title>[转载]表驱动法代码实践</title>

<link rel='canonical' href='https://blog.bugxch.top/p/%E8%BD%AC%E8%BD%BD%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B3%95%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content="[转载]表驱动法代码实践">
<meta property='og:description' content="这是一篇转载，点击查看原文链接。\n">
<meta property='og:url' content='https://blog.bugxch.top/p/%E8%BD%AC%E8%BD%BD%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B3%95%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5/'>
<meta property='og:site_name' content='巴巴变的博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='C/C&#43;&#43;' /><meta property='article:tag' content='重构' /><meta property='article:tag' content='设计' /><meta property='article:published_time' content='2021-01-22T08:07:14&#43;08:00'/><meta property='article:modified_time' content='2021-01-22T08:07:14&#43;08:00'/><meta property='og:image' content='https://pic.imgdb.cn/item/600a17e53ffa7d37b3da9d49.jpg' />
<meta name="twitter:title" content="[转载]表驱动法代码实践">
<meta name="twitter:description" content="这是一篇转载，点击查看原文链接。\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://pic.imgdb.cn/item/600a17e53ffa7d37b3da9d49.jpg' />
    <link rel="shortcut icon" href="/%5cfavicon.ico" />

  

<style>
    :root {
      --sys-font-family: "Noto Serif SC";
      --zh-font-family: "Noto Serif SC";
      --base-font-family: "Noto Serif SC";
      --code-font-family: "Noto Serif SC";
      --article-font-family: "Noto Serif SC";
    }
  </style>
  
  <script>
    (function () {
      const customFont = document.createElement("link");
      customFont.href =
        "https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap";
  
      customFont.type = "text/css";
      customFont.rel = "stylesheet";
  
      document.head.appendChild(customFont);
    })();
  </script>
  
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hue8037ab3c5772f21a937200919ce7a89_163234_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">巴巴变的博客</a></h1>
            <h2 class="site-description">平凡的生活也值得记录</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E6%94%B6%E9%9B%86/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>收集</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E8%BD%AC%E8%BD%BD%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B3%95%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5/">
                
                    <img src="https://pic.imgdb.cn/item/600a17e53ffa7d37b3da9d49.jpg" loading="lazy" alt="Featured image of post [转载]表驱动法代码实践" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%8A%80%E8%89%BA/" >
                技艺
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E8%BD%AC%E8%BD%BD%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B3%95%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5/">[转载]表驱动法代码实践</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 22, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 18 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>这是一篇转载，点击查看<a class="link" href="https://www.cnblogs.com/clover-toeic/p/3730362.html"  target="_blank" rel="noopener"
    >原文链接</a>。</p>
<blockquote>
<p>数据压倒一切。如果选择了正确的数据结构并把一切组织的井井有条，正确的算法就不言自明。编程的核心是数据结构，而不是算法. &ndash; Rob Pike</p>
</blockquote>
<p>本文基于这样的认识：数据是易变的，逻辑是稳定的。本文例举的编程实现多为代码片段，但不影响描述的完整性。本文例举的编程虽然基于C语言，但其编程思想也适用于其他语言。此外，本文不涉及语言相关的运行效率讨论。</p>
<h2 id="概念提出">概念提出
</h2><p>所谓表驱动法(Table-Driven Approach)简而言之就是用查表的方法获取数据。此处的“表”通常为数组，但可视为数据库的一种体现。根据字典中的部首检字表查找读音未知的汉字就是典型的表驱动法，即以每个字的字形为依据，计算出一个索引值，并映射到对应的页数。相比一页一页地顺序翻字典查字，部首检字法效率极高。</p>
<p>具体到编程方面，在数据不多时可用逻辑判断语句(if…else或switch…case)来获取值；但随着数据的增多，逻辑语句会越来越长，此时表驱动法的优势就开始显现。例如，用36进制(A表示10，B表示11，…)表示更大的数字，逻辑判断语句如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(ucNum <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ucNumChar <span style="color:#f92672">=</span> ConvertToChar(ucNum);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(ucNum <span style="color:#f92672">==</span> <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ucNumChar <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(ucNum <span style="color:#f92672">==</span> <span style="color:#ae81ff">11</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ucNumChar <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;B&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(ucNum <span style="color:#f92672">==</span> <span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ucNumChar <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(ucNum <span style="color:#f92672">==</span> <span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ucNumChar <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Z&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>当然也可以用switch…case结构，但实现都很冗长。而用表驱动法(将numChar存入数组)则非常直观和简洁。如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>CHAR aNumChars[] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">&#39;2&#39;</span>, <span style="color:#75715e">/*3~9*/</span><span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#75715e">/*D~Y*/</span><span style="color:#e6db74">&#39;Z&#39;</span>};
</span></span><span style="display:flex;"><span>CHAR ucNumChar <span style="color:#f92672">=</span> aNumChars[ucNum <span style="color:#f92672">%</span> <span style="color:#66d9ef">sizeof</span>(aNumChars)];
</span></span></code></pre></div><p>像这样直接将变量当作下数组下标来读取数值的方法就是直接查表法。注意，如果熟悉字符串操作，则上述写法可以更简洁：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>CHAR ucNumChar <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>[ucNum];
</span></span></code></pre></div><p>使用表驱动法时需要关注两个问题：一是如何查表，从表中读取正确的数据；二是表里存放什么，如数值或函数指针。前者参见1.1节“查表方式”内容，后者参见1.2节“实战示例”内容。</p>
<h3 id="查表方式">查表方式
</h3><p>常用的查表方式有直接查找、索引查找和分段查找等。</p>
<h4 id="直接查找">直接查找
</h4><p>即直接通过数组下标获取到数据。如果熟悉哈希表的话，可以很容易看出这种查表方式就是哈希表的直接访问法。如获取星期名称，逻辑判断语句如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">0</span> <span style="color:#f92672">==</span> ucDay)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    pszDayName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Sunday&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> ucDay)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    pszDayName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Monday&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(<span style="color:#ae81ff">6</span> <span style="color:#f92672">==</span> ucDay)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    pszDayName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Saturday&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>而实现同样的功能，可将这些数据存储到一个表里：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>CHAR <span style="color:#f92672">*</span>paNumChars[] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Sunday&#34;</span>, <span style="color:#e6db74">&#34;Monday&#34;</span>, <span style="color:#e6db74">&#34;Tuesday&#34;</span>, <span style="color:#e6db74">&#34;Wednesday&#34;</span>, <span style="color:#e6db74">&#34;Thursday&#34;</span>, <span style="color:#e6db74">&#34;Friday&#34;</span>,  <span style="color:#e6db74">&#34;Saturday&#34;</span>};
</span></span><span style="display:flex;"><span>CHAR <span style="color:#f92672">*</span>pszDayName <span style="color:#f92672">=</span> paNumChars[ucDay];
</span></span></code></pre></div><p>类似哈希表特性，表驱动法适用于无需有序遍历数据，且数据量大小可提前预测的情况。对于过于复杂和庞大的判断，可将数据存为文件，需要时加载文件初始化数组，从而在不修改程序的情况下调整里面的数值。</p>
<p>有时，访问之前需要先进行一次键值转换。如表驱动法表示端口忙闲时，需将槽位端口号映射为全局编号。所生成的端口数目大小的数组，其下标对应全局端口编号，元素值表示相应端口的忙闲状态。</p>
<h4 id="索引查找">索引查找
</h4><p>有时通过一次键值转换，依然无法把数据(如英文单词等)转为键值。此时可将转换的对应关系写到一个索引表里，即索引访问。</p>
<p>如现有100件商品，4位编号，范围从0000到9999。此时只需要申请一个长度为100的数组，且对应2位键值。但将4位的编号转换为2位的键值，可能过于复杂或没有规律，最合适的方法是建立一个保存该转换关系的索引表。采用索引访问既节省内存，又方便维护。比如索引A表示通过名称访问，索引B表示通过编号访问。</p>
<h4 id="分段查找">分段查找
</h4><p>通过确定数据所处的范围确定分类(下标)。有的数据可分成若干区间，即具有阶梯性，如分数等级。此时可将每个区间的上限(或下限)存到一个表中，将对应的值存到另一表中，通过第一个表确定所处的区段，再由区段下标在第二个表里读取相应数值。注意要留意端点，可用二分法查找，另外可考虑通过索引方法来代替。如根据分数查绩效等级：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#define MAX_GRADE_LEVEL   (INT8U)5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DOUBLE aRangeLimit[MAX_GRADE_LEVEL] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">50.0</span>, <span style="color:#ae81ff">60.0</span>, <span style="color:#ae81ff">70.0</span>, <span style="color:#ae81ff">80.0</span>, <span style="color:#ae81ff">100.0</span>};
</span></span><span style="display:flex;"><span>CHAR <span style="color:#f92672">*</span>paGrades[MAX_GRADE_LEVEL] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Fail&#34;</span>, <span style="color:#e6db74">&#34;Pass&#34;</span>, <span style="color:#e6db74">&#34;Credit&#34;</span>, <span style="color:#e6db74">&#34;Distinction&#34;</span>, <span style="color:#e6db74">&#34;High Distinction&#34;</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> CHAR<span style="color:#f92672">*</span> <span style="color:#a6e22e">EvaluateGrade</span>(DOUBLE dScore)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT8U ucLevel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(; ucLevel <span style="color:#f92672">&lt;</span> MAX_GRADE_LEVEL; ucLevel<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(dScore <span style="color:#f92672">&lt;</span> aRangeLimit[ucLevel])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> paGrades[ucLevel];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> paGrades[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上述两张表(数组)也可合并为一张表(结构体数组)，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    DOUBLE  aRangeLimit;
</span></span><span style="display:flex;"><span>    CHAR    <span style="color:#f92672">*</span>pszGrade;
</span></span><span style="display:flex;"><span>}T_GRADE_MAP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>T_GRADE_MAP gGradeMap[MAX_GRADE_LEVEL] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">50.0</span>,              <span style="color:#e6db74">&#34;Fail&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">60.0</span>,              <span style="color:#e6db74">&#34;Pass&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">70.0</span>,              <span style="color:#e6db74">&#34;Credit&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">80.0</span>,              <span style="color:#e6db74">&#34;Distinction&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">100.0</span>,             <span style="color:#e6db74">&#34;High Distinction&#34;</span>}
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> CHAR<span style="color:#f92672">*</span> <span style="color:#a6e22e">EvaluateGrade</span>(DOUBLE dScore)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT8U ucLevel <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(; ucLevel <span style="color:#f92672">&lt;</span> MAX_GRADE_LEVEL; ucLevel<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(dScore <span style="color:#f92672">&lt;</span> gGradeMap[ucLevel].aRangeLimit)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> gGradeMap[ucLevel].pszGrade;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> gGradeMap[<span style="color:#ae81ff">0</span>].pszGrade;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>该表结构已具备的数据库的雏形，并可扩展支持更为复杂的数据。其查表方式通常为索引查找，偶尔也为分段查找；当索引具有规律性(如连续整数)时，退化为直接查找。</p>
<p>使用分段查找法时应注意边界，将每一分段范围的上界值都考虑在内。找出所有不在最高一级范围内的值，然后把剩下的值全部归入最高一级中。有时需要人为地为最高一级范围添加一个上界。同时应小心不要错误地用“&lt;”来代替“&lt;=”。要保证循环在找出属于最高一级范围内的值后恰当地结束，同时也要保证恰当处理范围边界。</p>
<h3 id="实战示例">实战示例
</h3><p>本节多数示例取自实际项目。表形式为一维数组、二维数组和结构体数组；表内容有数据、字符串和函数指针。基于表驱动的思想，表形式和表内容可衍生出丰富的组合。</p>
<h4 id="字符统计">字符统计
</h4><p>问题：统计用户输入的一串数字中每个数字出现的次数。普通解法主体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>INT32U aDigitCharNum[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>}; <span style="color:#75715e">/* 输入字符串中各数字字符出现的次数 */</span>
</span></span><span style="display:flex;"><span>INT32U dwStrLen <span style="color:#f92672">=</span> strlen(szDigits);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INT32U dwStrIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(; dwStrIdx <span style="color:#f92672">&lt;</span> dwStrLen; dwStrIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(szDigits[dwStrIdx])
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;1&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            aDigitCharNum[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;2&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            aDigitCharNum[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            aDigitCharNum[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这种解法的缺点显而易见，既不美观也不灵活。其问题关键在于未将数字字符与数组aDigitCharNum下标直接关联起来。以下示出更简洁的实现方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(; dwStrIdx <span style="color:#f92672">&lt;</span> dwStrLen; dwStrIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    aDigitCharNum[szDigits[dwStrIdx] <span style="color:#f92672">-</span> <span style="color:#e6db74">&#39;0&#39;</span>]<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>上述实现考虑到0也为数字字符。该解法也可扩展至统计所有ASCII可见字符。</p>
<h4 id="月天校验">月天校验
</h4><p>问题：对给定年份和月份的天数进行校验(需区分平年和闰年)。普通解法主体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">switch</span>(OnuTime.Month)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">7</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">8</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(OnuTime.Day<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">31</span> <span style="color:#f92672">||</span> OnuTime.Day<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            CtcOamLog(FUNCTION_Pon,<span style="color:#e6db74">&#34;Don&#39;t support this Day: %d(1~31)!!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, OnuTime.Day);
</span></span><span style="display:flex;"><span>            retcode <span style="color:#f92672">=</span> S_ERROR;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(((OnuTime.Year<span style="color:#f92672">%</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (OnuTime.Year<span style="color:#f92672">%</span><span style="color:#ae81ff">100</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">||</span> (OnuTime.Year<span style="color:#f92672">%</span><span style="color:#ae81ff">400</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(OnuTime.Day<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">29</span> <span style="color:#f92672">||</span> OnuTime.Day<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                CtcOamLog(FUNCTION_Pon,<span style="color:#e6db74">&#34;Don&#39;t support this Day: %d(1~29)!!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, OnuTime.Day);
</span></span><span style="display:flex;"><span>                retcode <span style="color:#f92672">=</span> S_ERROR;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(OnuTime.Day<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">28</span> <span style="color:#f92672">||</span> OnuTime.Day<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                CtcOamLog(FUNCTION_Pon,<span style="color:#e6db74">&#34;Don&#39;t support this Day: %d(1~28)!!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, OnuTime.Day);
</span></span><span style="display:flex;"><span>                retcode <span style="color:#f92672">=</span> S_ERROR;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">9</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">11</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(OnuTime.Day<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">||</span> OnuTime.Day<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            CtcOamLog(FUNCTION_Pon,<span style="color:#e6db74">&#34;Don&#39;t support this Day: %d(1~30)!!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, OnuTime.Day);
</span></span><span style="display:flex;"><span>            retcode <span style="color:#f92672">=</span> S_ERROR;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        CtcOamLog(FUNCTION_Pon,<span style="color:#e6db74">&#34;Don&#39;t support this Month: %d(1~12)!!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, OnuTime.Month);
</span></span><span style="display:flex;"><span>        retcode <span style="color:#f92672">=</span> S_ERROR;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下示出更简洁的实现方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#define MONTH_OF_YEAR 12    </span><span style="color:#75715e">/* 一年中的月份数 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 闰年：能被4整除且不能被100整除，或能被400整除 */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define IS_LEAP_YEAR(year) ((((year) % 4 == 0) &amp;&amp; ((year) % 100 != 0)) || ((year) % 400 == 0))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 平年中的各月天数，下标对应月份 */</span>
</span></span><span style="display:flex;"><span>INT8U aDayOfCommonMonth[MONTH_OF_YEAR] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">31</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INT8U ucMaxDay <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>((OnuTime.Month <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;&amp;</span> (IS_LEAP_YEAR(OnuTime.Year)))
</span></span><span style="display:flex;"><span>    ucMaxDay <span style="color:#f92672">=</span> aDayOfCommonMonth[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    ucMaxDay <span style="color:#f92672">=</span> aDayOfCommonMonth[OnuTime.Month<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>((OnuTime.Day <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">||</span> (OnuTime.Day <span style="color:#f92672">&gt;</span> ucMaxDay)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CtcOamLog(FUNCTION_Pon,<span style="color:#e6db74">&#34;Month %d doesn&#39;t have this Day: %d(1~%d)!!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>              OnuTime.Month, OnuTime.Day, ucMaxDay);
</span></span><span style="display:flex;"><span>    retcode <span style="color:#f92672">=</span> S_ERROR;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="名称构造">名称构造
</h4><p>问题：根据WAN接口承载的业务类型(Bitmap)构造业务类型名称字符串。普通解法主体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Sub_SetServerType</span>(INT8U <span style="color:#f92672">*</span>ServerType, INT16U wan_servertype)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((wan_servertype <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0001</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0001</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        strcat(ServerType, <span style="color:#e6db74">&#34;_INTERNET&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((wan_servertype <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0002</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0002</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        strcat(ServerType, <span style="color:#e6db74">&#34;_TR069&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((wan_servertype <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0004</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0004</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        strcat(ServerType, <span style="color:#e6db74">&#34;_VOIP&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((wan_servertype <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0008</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x0008</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        strcat(ServerType, <span style="color:#e6db74">&#34;_OTHER&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下示出C语言中更简洁的实现方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#define  GET_BIT(var, bit)   (((var) &gt;&gt; (bit)) &amp; 0x1)    </span><span style="color:#75715e">/* 获取var变量第bit位，编号从右至左 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> CHAR<span style="color:#f92672">*</span> paSvrNames[] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;_INTERNET&#34;</span>, <span style="color:#e6db74">&#34;_TR069&#34;</span>, <span style="color:#e6db74">&#34;_VOIP&#34;</span>, <span style="color:#e6db74">&#34;_OTHER&#34;</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> INT8U ucSvrNameNum <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(paSvrNames) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(paSvrNames[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">SetServerType</span>(CHAR <span style="color:#f92672">*</span>pszSvrType, INT16U wSvrType)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT8U ucIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(; ucIdx <span style="color:#f92672">&lt;</span> ucSvrNameNum; ucIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> GET_BIT(wSvrType, ucIdx))
</span></span><span style="display:flex;"><span>            strcat(pszSvrType, paSvrNames[ucIdx]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>新的实现将数据和逻辑分离，维护起来非常方便。只要逻辑(规则)不变，则唯一可能的改动就是数据(paSvrNames)。</p>
<h4 id="值名解析">值名解析
</h4><p>问题：根据枚举变量取值输出其对应的字符串，如PORT_FE(1)输出“Fe”。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span> <span style="color:#75715e">//值名映射表结构体定义，用于数值解析器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    INT32U dwElem;    <span style="color:#75715e">//待解析数值，通常为枚举变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CHAR<span style="color:#f92672">*</span>  pszName;   <span style="color:#75715e">//指向数值所对应解析名字符串的指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}T_NAME_PARSER;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/******************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 函数名称:  NameParser
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 功能说明:  数值解析器，将给定数值转换为对应的具名字符串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 输入参数:  VOID *pvMap       :值名映射表数组，含T_NAME_PARSER结构体类型元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                                VOID指针允许用户在保持成员数目和类型不变的前提下，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                                定制更有意义的结构体名和/或成员名。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             INT32U dwEntryNum :值名映射表数组条目数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             INT32U dwElem     :待解析数值，通常为枚举变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             INT8U* pszDefName :缺省具名字符串指针，可为空
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 输出参数:  NA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 返回值  :  INT8U *: 数值所对应的具名字符串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             当无法解析给定数值时，若pszDefName为空，则返回数值对应的16进制格式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             字符串；否则返回pszDefName。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">******************************************************************************/</span>
</span></span><span style="display:flex;"><span>INT8U <span style="color:#f92672">*</span><span style="color:#a6e22e">NameParser</span>(VOID <span style="color:#f92672">*</span>pvMap, INT32U dwEntryNum, INT32U dwElem, INT8U<span style="color:#f92672">*</span> pszDefName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CHECK_SINGLE_POINTER(pvMap, <span style="color:#e6db74">&#34;NullPoniter&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    INT32U dwEntryIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(dwEntryIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; dwEntryIdx <span style="color:#f92672">&lt;</span> dwEntryNum; dwEntryIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        T_NAME_PARSER <span style="color:#f92672">*</span>ptNameParser <span style="color:#f92672">=</span> (T_NAME_PARSER <span style="color:#f92672">*</span>)pvMap;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(dwElem <span style="color:#f92672">==</span> ptNameParser<span style="color:#f92672">-&gt;</span>dwElem)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ptNameParser<span style="color:#f92672">-&gt;</span>pszName;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//ANSI标准禁止对void指针进行算法操作；GNU标准则指定void*算法操作与char*一致。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//若考虑移植性，可将pvMap类型改为INT8U*，或定义INT8U*局部变量指向pvMap。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        pvMap <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(T_NAME_PARSER);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(NULL <span style="color:#f92672">!=</span> pszDefName)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> pszDefName;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> INT8U szName[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>}; <span style="color:#75715e">//Max:&#34;0xFFFFFFFF&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sprintf(szName, <span style="color:#e6db74">&#34;0x%X&#34;</span>, dwElem);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> szName;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下给出NameParser的简单应用示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">//UNI端口类型值名映射表结构体定义
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    INT32U dwPortType;
</span></span><span style="display:flex;"><span>    INT8U<span style="color:#f92672">*</span> pszPortName;
</span></span><span style="display:flex;"><span>}T_PORT_NAME;
</span></span><span style="display:flex;"><span><span style="color:#75715e">//UNI端口类型解析器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>T_PORT_NAME gUniNameMap[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">1</span>,      <span style="color:#e6db74">&#34;Fe&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">3</span>,      <span style="color:#e6db74">&#34;Pots&#34;</span>},
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">99</span>,     <span style="color:#e6db74">&#34;Vuni&#34;</span>}
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> INT32U UNI_NAM_MAP_NUM <span style="color:#f92672">=</span> (INT32U)(<span style="color:#66d9ef">sizeof</span>(gUniNameMap)<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(T_PORT_NAME));
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">NameParserTest</span>(VOID)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT8U ucTestIndex <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;Unknown&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;Unknown&#34;</span>)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;DefName&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;DefName&#34;</span>)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;Fe&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Unknown&#34;</span>)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;Pots&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;Unknown&#34;</span>)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;Vuni&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">99</span>, NULL)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;Unknown&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">255</span>, <span style="color:#e6db74">&#34;Unknown&#34;</span>)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;0xABCD&#34;</span>, NameParser(gUniNameMap, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">0xABCD</span>, NULL)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;[%s]&lt;Test Case %u&gt; Result: %s!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FUNCTION__, ucTestIndex<span style="color:#f92672">++</span>,
</span></span><span style="display:flex;"><span>           strcmp(<span style="color:#e6db74">&#34;NullPoniter&#34;</span>, NameParser(NULL, UNI_NAM_MAP_NUM, <span style="color:#ae81ff">0xABCD</span>, NULL)) <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ERROR&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OK&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>gUniNameMap</code>在实际项目中有十余个条目，若采用逻辑链实现将非常冗长。</p>
<h4 id="取值映射">取值映射
</h4><p>问题：不同模块间同一参数枚举值取值可能有所差异，需要适配。此处不再给出普通的switch…case或if…else if…else结构，而直接示出以下表驱动实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    PORTSTATE loopMEState;
</span></span><span style="display:flex;"><span>    PORTSTATE loopMIBState;
</span></span><span style="display:flex;"><span>}LOOPMAPSTRUCT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> LOOPMAPSTRUCT s_CesLoop[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {NO_LOOP,                  e_ds1_looptype_noloop},
</span></span><span style="display:flex;"><span>    {PAYLOAD_LOOP,             e_ds1_looptype_PayloadLoop},
</span></span><span style="display:flex;"><span>    {LINE_LOOP,                e_ds1_looptype_LineLoop},
</span></span><span style="display:flex;"><span>    {PON_LOOP,                 e_ds1_looptype_OtherLoop},
</span></span><span style="display:flex;"><span>    {CES_LOOP,                 e_ds1_looptype_InwardLoop}};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORTSTATE <span style="color:#a6e22e">ConvertLoopMEStateToMIBState</span>(PORTSTATE vPortState)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT32U num <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, ii;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    num <span style="color:#f92672">=</span> ARRAY_NUM(s_CesLoop);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(ii <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ii <span style="color:#f92672">&lt;</span> num; ii<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(vPortState <span style="color:#f92672">==</span> s_CesLoop[ii].loopMEState)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> s_CesLoop[ii].loopMIBState;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> e_ds1_looptype_noloop;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>相应地，从loopMIBState映射到loopMEState需要定义一个ConvertLoopMIBStateToMEState函数。更进一步，所有类似的一对一映射关系都必须如上的映射(转换)函数，相当繁琐。事实上，从抽象层面看，该映射关系非常简单。提取共性后定义带参数宏，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">/**********************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 功能描述：进行二维数组映射表的一对一映射，用于参数适配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 参数说明：map        -- 二维数组映射表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            elemSrc    -- 映射源，即待映射的元素值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            elemDest   -- 映射源对应的映射结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            direction  -- 映射方向字节，表示从数组哪列映射至哪列。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                          高4位对应映射源列，低4位对应映射结果列。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            defaultVal -- 映射失败时置映射结果为缺省值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 示例：    ARRAY_MAPPER(gCesLoopMap, 3, ucLoop, 0x10, NO_LOOP);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            则ucLoop = 2(LINE_LOOP)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**********************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define ARRAY_MAPPER(map, elemSrc, elemDest, direction, defaultVal) do{\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    INT8U ucMapIdx = 0, ucMapNum = 0; \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ucMapNum = sizeof(map)/sizeof(map[0]); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    for(ucMapIdx = 0; ucMapIdx &lt; ucMapNum; ucMapIdx++) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    { \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        if((elemSrc) == map[ucMapIdx][((direction)&amp;0xF0)&gt;&gt;4]) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        { \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            elemDest = map[ucMapIdx][(direction)&amp;0x0F]; \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            break; \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        } \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    } \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    if(ucMapIdx == ucMapNum) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    { \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        elemDest = (defaultVal); \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    } \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">}while(0)
</span></span></span></code></pre></div><p>参数取值转换时直接调用统一的映射器宏，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> INT8U gCesLoopMap[][<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {NO_LOOP,                  e_ds1_looptype_noloop},
</span></span><span style="display:flex;"><span>    {PAYLOAD_LOOP,             e_ds1_looptype_PayloadLoop},
</span></span><span style="display:flex;"><span>    {LINE_LOOP,                e_ds1_looptype_LineLoop},
</span></span><span style="display:flex;"><span>    {PON_LOOP,                 e_ds1_looptype_OtherLoop},
</span></span><span style="display:flex;"><span>    {CES_LOOP,                 e_ds1_looptype_InwardLoop}};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ARRAY_MAPPER(gCesLoopMap, tPara.dwParaVal[<span style="color:#ae81ff">0</span>], dwLoopConf, <span style="color:#ae81ff">0x01</span>, e_ds1_looptype_noloop);
</span></span></code></pre></div><p>另举一例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#define  CES_DEFAULT_JITTERBUF        (INT32U)2000   </span><span style="color:#75715e">/* 默认jitterbuf为2000us，而1帧=125us */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define  CES_JITTERBUF_STEP           (INT32U)125    </span><span style="color:#75715e">/* jitterbuf步长为125us，即1帧 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define  CES_DEFAULT_QUEUESIZE        (INT32U)5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define  CES_DEFAULT_MAX_QUEUESIZE    (INT32U)7
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define  ARRAY_NUM(array)             (sizeof(array) / sizeof((array)[0]))  </span><span style="color:#75715e">/* 数组元素个数 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    INT32U  dwJitterBuffer;
</span></span><span style="display:flex;"><span>    INT32U  dwFramePerPkt;
</span></span><span style="display:flex;"><span>    INT32U  dwQueueSize;
</span></span><span style="display:flex;"><span>}QUEUE_SIZE_MAP;
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* gCesQueueSizeMap也可以(JitterBuffer / FramePerPkt)值为索引，更加紧凑 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> QUEUE_SIZE_MAP gCesQueueSizeMap[]<span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>},  {<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>},  {<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>},  {<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>},  {<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>},  {<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>},  {<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>},  {<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>},  {<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>},  {<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>},  {<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>},  {<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>},  {<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>},  {<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>},  {<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">11</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>}, {<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">12</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">13</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">13</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>}, {<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">15</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>}, {<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">19</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">19</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">21</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">21</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">22</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">22</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">23</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">23</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">25</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">25</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">26</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">26</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">27</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">27</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">29</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">29</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">30</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">30</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>},
</span></span><span style="display:flex;"><span>       {<span style="color:#ae81ff">31</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">31</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}, {<span style="color:#ae81ff">32</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>}, {<span style="color:#ae81ff">32</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">5</span>}};
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**********************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 函数名称： CalcQueueSize
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 功能描述： 根据JitterBuffer和FramePerPkt计算QueueSize
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 注意事项： 配置的最大缓存深度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*            = 2 * JitterBuffer / FramePerPkt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*            = 2 * N Packet = 2 ^ QueueSize
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*            JitterBuffer为125us帧速率的倍数，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*            FramePerPkt为每个分组的帧数，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*            QueueSize向上取整，最大为7。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**********************************************************/</span>
</span></span><span style="display:flex;"><span>INT32U <span style="color:#a6e22e">CalcQueueSize</span>(INT32U dwJitterBuffer, INT32U dwFramePerPkt)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT8U ucIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, ucNum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//本函数暂时仅考虑E1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ucNum <span style="color:#f92672">=</span> ARRAY_NUM(gCesQueueSizeMap);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(ucIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ucIdx <span style="color:#f92672">&lt;</span> ucNum; ucIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">if</span>((dwJitterBuffer <span style="color:#f92672">==</span> gCesQueueSizeMap[ucIdx].dwJitterBuffer) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>          (dwFramePerPkt <span style="color:#f92672">==</span> gCesQueueSizeMap[ucIdx].dwFramePerPkt))
</span></span><span style="display:flex;"><span>       {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> gCesQueueSizeMap[ucIdx].dwQueueSize;
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> CES_DEFAULT_MAX_QUEUESIZE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="版本控制">版本控制
</h4><p>问题：控制OLT与ONU之间的版本协商。ONU本地设置三比特控制字，其中bit2(MSB)~bit0(LSB)分别对应0x21、0x30和0xAA版本号；且bitX为0表示上报对应版本号，bitX为1表示不上报对应版本号。其他版本号如0x20、0x13和0x1必须上报，即不受控制。最初的实现采用if…else if…else结构，代码非常冗长，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>pstSendTlv<span style="color:#f92672">-&gt;</span>ucLength <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1f</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (gOamCtrlCode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    vosMemCpy(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList, ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x30</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">4</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x21</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">8</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">12</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x13</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">16</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">20</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">23</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xaa</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (gOamCtrlCode <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    vosMemCpy(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList, ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x30</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">4</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x21</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">8</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">12</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x13</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">16</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">19</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//此处省略gOamCtrlCode == 2~6的处理代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (gOamCtrlCode <span style="color:#f92672">==</span> <span style="color:#ae81ff">7</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">4</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x13</span>;
</span></span><span style="display:flex;"><span>    vosMemCpy(<span style="color:#f92672">&amp;</span>(pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">8</span>]), ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下示出C语言中更简洁的实现方式(基于二维数组)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">/**********************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 版本控制字数组定义
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* gOamCtrlCode:   Bitmap控制字。Bit-X为0时上报对应版本，Bit-X为1时屏蔽对应版本。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* CTRL_VERS_NUM:  可控版本个数。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* CTRL_CODE_NUM:  控制字个数。与CTRL_VERS_NUM有关。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* gOamVerCtrlMap: 版本控制字数组。行对应控制字，列对应可控版本。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  元素值为0时不上报对应版本，元素值非0时上报该元素值。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Note: 该数组旨在实现“数据与控制隔离”。后续若要新增可控版本，只需修改
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  -- CTRL_VERS_NUM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  -- gOamVerCtrlMap新增行(控制字)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  -- gOamVerCtrlMap新增列(可控版本)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">**********************************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define CTRL_VERS_NUM    3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CTRL_CODE_NUM    (1&lt;&lt;CTRL_VERS_NUM)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>u8_t gOamVerCtrlMap[CTRL_CODE_NUM][CTRL_VERS_NUM] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* Ver21         Ver30        VerAA */</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">0x21</span>,         <span style="color:#ae81ff">0x30</span>,        <span style="color:#ae81ff">0xaa</span>},    <span style="color:#75715e">/*gOamCtrlCode = 0*/</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">0x21</span>,         <span style="color:#ae81ff">0x30</span>,          <span style="color:#ae81ff">0</span> },    <span style="color:#75715e">/*gOamCtrlCode = 1*/</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">0x21</span>,           <span style="color:#ae81ff">0</span>,         <span style="color:#ae81ff">0xaa</span>},    <span style="color:#75715e">/*gOamCtrlCode = 2*/</span>
</span></span><span style="display:flex;"><span>    {<span style="color:#ae81ff">0x21</span>,           <span style="color:#ae81ff">0</span>,           <span style="color:#ae81ff">0</span> },    <span style="color:#75715e">/*gOamCtrlCode = 3*/</span>
</span></span><span style="display:flex;"><span>    {  <span style="color:#ae81ff">0</span>,          <span style="color:#ae81ff">0x30</span>,        <span style="color:#ae81ff">0xaa</span>},    <span style="color:#75715e">/*gOamCtrlCode = 4*/</span>
</span></span><span style="display:flex;"><span>    {  <span style="color:#ae81ff">0</span>,          <span style="color:#ae81ff">0x30</span>,          <span style="color:#ae81ff">0</span> },    <span style="color:#75715e">/*gOamCtrlCode = 5*/</span>
</span></span><span style="display:flex;"><span>    {  <span style="color:#ae81ff">0</span>,            <span style="color:#ae81ff">0</span>,         <span style="color:#ae81ff">0xaa</span>},    <span style="color:#75715e">/*gOamCtrlCode = 6*/</span>
</span></span><span style="display:flex;"><span>    {  <span style="color:#ae81ff">0</span>,            <span style="color:#ae81ff">0</span>,           <span style="color:#ae81ff">0</span> }     <span style="color:#75715e">/*gOamCtrlCode = 7*/</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define INFO_TYPE_VERS_LEN    7  </span><span style="color:#75715e">/* InfoType + Length + OUI + ExtSupport + Version */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>u8_t verIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>u8_t index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(verIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; verIdx <span style="color:#f92672">&lt;</span> CTRL_VERS_NUM; verIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(gOamVerCtrlMap[gOamCtrlCode][verIdx] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        vosMemCpy(<span style="color:#f92672">&amp;</span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index], ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>        pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> gOamVerCtrlMap[gOamCtrlCode][verIdx];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>vosMemCpy(<span style="color:#f92672">&amp;</span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index], ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>vosMemCpy(<span style="color:#f92672">&amp;</span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index], ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x13</span>;
</span></span><span style="display:flex;"><span>vosMemCpy(<span style="color:#f92672">&amp;</span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index], ctc_oui, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>pstSendTlv<span style="color:#f92672">-&gt;</span>aucVersionList[index<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x01</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pstSendTlv<span style="color:#f92672">-&gt;</span>ucLength <span style="color:#f92672">=</span> INFO_TYPE_VERS_LEN <span style="color:#f92672">+</span> index;
</span></span></code></pre></div><h4 id="消息处理">消息处理
</h4><p>问题：终端输入不同的打印命令，调用相应的打印函数，以控制不同级别的打印。</p>
<p>这是一段消息(事件)驱动程序。本模块接收其他模块(如串口驱动)发送的消息，根据消息中的打印级别字符串和开关模式，调用不同函数进行处理。常见的实现方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">logall</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    g_log_control[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xFFFFFFFF</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">noanylog</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    g_log_control[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">logOam</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    g_log_control[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">0x01</span> <span style="color:#f92672">&lt;&lt;</span> FUNCTION_Oam);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nologOam</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    g_log_control[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">0x01</span> <span style="color:#f92672">&lt;&lt;</span> FUNCTION_Oam);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">logExec</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, INT8U enable)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    CtcOamLog(FUNCTION_Oam,<span style="color:#e6db74">&#34;log %s %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,name,enable);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (enable <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">/*log*/</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;all&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">/*字符串比较，不区分大小写*/</span>
</span></span><span style="display:flex;"><span>            logall();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;oam&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            logOam();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;pon&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            logPon();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;version&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            logVersion();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (enable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">/*nolog*/</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;all&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            noanylog();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;oam&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            nologOam();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;pon&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            nologPon();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcasecmp(name,<span style="color:#e6db74">&#34;version&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            nologVersion();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;bad log para</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以下示出C语言中更简洁的实现方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    OAM_LOG_OFF <span style="color:#f92672">=</span> (INT8U)<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    OAM_LOG_ON  <span style="color:#f92672">=</span> (INT8U)<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>}E_OAM_LOG_MODE;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">FUNC_STATUS</span> (<span style="color:#f92672">*</span>OamLogHandler)(VOID);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>    CHAR           <span style="color:#f92672">*</span>pszLogCls;    <span style="color:#75715e">/* 打印级别 */</span>
</span></span><span style="display:flex;"><span>    E_OAM_LOG_MODE eLogMode;      <span style="color:#75715e">/* 打印模式 */</span>
</span></span><span style="display:flex;"><span>    OamLogHandler  fnLogHandler;  <span style="color:#75715e">/* 打印函数 */</span>
</span></span><span style="display:flex;"><span>}T_OAM_LOG_MAP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>T_OAM_LOG_MAP gOamLogMap[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;all&#34;</span>,         OAM_LOG_OFF,       noanylog},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;oam&#34;</span>,         OAM_LOG_OFF,       nologOam},
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {<span style="color:#e6db74">&#34;version&#34;</span>,     OAM_LOG_OFF,       nologVersion},
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;all&#34;</span>,         OAM_LOG_ON,        logall},
</span></span><span style="display:flex;"><span>    {<span style="color:#e6db74">&#34;oam&#34;</span>,         OAM_LOG_ON,        logOam},
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//... ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {<span style="color:#e6db74">&#34;version&#34;</span>,     OAM_LOG_ON,        logVersion}
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>INT32U gOamLogMapNum <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(gOamLogMap) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(T_OAM_LOG_MAP);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">logExec</span>(CHAR <span style="color:#f92672">*</span>pszName, INT8U ucSwitch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    INT8U ucIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(; ucIdx <span style="color:#f92672">&lt;</span> gOamLogMapNum; ucIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>((ucSwitch <span style="color:#f92672">==</span> gOamLogMap[ucIdx].eLogMode) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>           (<span style="color:#f92672">!</span>strcasecmp(pszName, gOamLogMap[ucIdx].pszLogCls));
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            gOamLogMap[ucIdx].fnLogHandler();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(ucIdx <span style="color:#f92672">==</span> gOamLogMapNum)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Unknown LogClass(%s) or LogMode(%d)!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pszName, ucSwitch);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这种表驱动消息处理实现的优点如下：</p>
<ul>
<li>增强可读性，消息如何处理从表中一目了然。</li>
<li>增强可扩展性。更容易修改，要增加新的消息，只要修改数据即可，不需要修改流程。</li>
<li>降低复杂度。通过把程序逻辑的复杂度转移到人类更容易处理的数据中来，从而达到控制复杂度的目标。</li>
<li>主干清晰，代码重用。
若各索引为顺序枚举值，则建立多维数组(每维对应一个索引)，根据下标直接定位到处理函数，效率会更高。</li>
</ul>
<p>注意，考虑到本节实例中logOam/logPon或nologOam/nologPon等函数本质上是基于打印级别的比特操作，因此可进一步简化。以下例举其相似实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">/* 日志控制类型定义 */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LOG_NORM <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">/* 未分类日志，可用于通用日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_FRM,             <span style="color:#75715e">/* Frame，OMCI帧日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_PON,             <span style="color:#75715e">/* Pon，光链路相关日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_ETH,             <span style="color:#75715e">/* Ethernet，Layer2以太网日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_NET,             <span style="color:#75715e">/* Internet，Layer3网络日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_MULT,            <span style="color:#75715e">/* Multicast，组播日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_QOS,             <span style="color:#75715e">/* QOS，流量日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_CES,             <span style="color:#75715e">/* Ces，TDM电路仿真日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_VOIP,            <span style="color:#75715e">/* Voip，语音日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_ALM,             <span style="color:#75715e">/* Alarm，告警日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_PERF,            <span style="color:#75715e">/* Performance，性能统计日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_VER,             <span style="color:#75715e">/* Version，软件升级日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_XDSL,            <span style="color:#75715e">/* xDsl日志 */</span>
</span></span><span style="display:flex;"><span>    LOG_DB,              <span style="color:#75715e">/* 数据库操作日志 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//新日志类型在此处扩展，共支持32种日志类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    LOG_ALL <span style="color:#f92672">=</span> UINT_MAX   <span style="color:#75715e">/* 所有日志类型 */</span>
</span></span><span style="display:flex;"><span>}E_LOG_TYPE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 变量名称：gOmciLogCtrl
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 作用描述：OMCI日志控制字，BitMap格式(比特编号从LSB至MSB依次为Bit0-&gt;BitN)。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *           Bit0~N分别对应E_LOG_TYPE各枚举值(除LOG_ALL外)。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *           BitX为0时关闭日志类型对应的日志功能，BitX为1时则予以打开。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 变量范围：该变量为四字节整型静态全局变量，即支持32种日志类型。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 访问说明：通过GetOmciLogCtrl/SetOmciLogCtrl/OmciLogCtrl函数访问/设置控制字。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *****************************************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> INT32U gOmciLogCtrl <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//日志类型字符串数组，下标为各字符串所对应的日志类型枚举值。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> INT8U<span style="color:#f92672">*</span> paLogTypeName[] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Norm&#34;</span>,        <span style="color:#e6db74">&#34;Frame&#34;</span>,   <span style="color:#e6db74">&#34;Pon&#34;</span>,  <span style="color:#e6db74">&#34;Ethernet&#34;</span>,  <span style="color:#e6db74">&#34;Internet&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Multicast&#34;</span>,   <span style="color:#e6db74">&#34;Qos&#34;</span>,     <span style="color:#e6db74">&#34;Ces&#34;</span>,  <span style="color:#e6db74">&#34;Voip&#34;</span>,      <span style="color:#e6db74">&#34;Alarm&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Performance&#34;</span>, <span style="color:#e6db74">&#34;Version&#34;</span>, <span style="color:#e6db74">&#34;Xdsl&#34;</span>,  <span style="color:#e6db74">&#34;Db&#34;</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> INT8U  ucLogTypeNameNum <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(paLogTypeName) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(paLogTypeName[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> VOID <span style="color:#a6e22e">SetGlobalLogCtrl</span>(E_LOG_TYPE eLogType, INT8U ucLogSwitch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(LOG_ON <span style="color:#f92672">==</span> ucLogSwitch)
</span></span><span style="display:flex;"><span>        gOmciLogCtrl <span style="color:#f92672">=</span> LOG_ALL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        gOmciLogCtrl <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> VOID <span style="color:#a6e22e">SetSpecificLogCtrl</span>(E_LOG_TYPE eLogType, INT8U ucLogSwitch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(LOG_ON <span style="color:#f92672">==</span> ucLogSwitch)
</span></span><span style="display:flex;"><span>        SET_BIT(gOmciLogCtrl, eLogType);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        CLR_BIT(gOmciLogCtrl, eLogType);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">OmciLogCtrl</span>(CHAR <span style="color:#f92672">*</span>pszLogType, INT8U ucLogSwitch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">0</span> <span style="color:#f92672">==</span> strncasecmp(pszLogType, <span style="color:#e6db74">&#34;All&#34;</span>, LOG_TYPE_CMP_LEN))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        SetGlobalLogCtrl(LOG_ALL, ucLogSwitch);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    INT8U ucIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(ucIdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ucIdx <span style="color:#f92672">&lt;</span> ucLogTypeNameNum; ucIdx<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">0</span> <span style="color:#f92672">==</span> strncasecmp(pszLogType, paLogTypeName[ucIdx], LOG_TYPE_CMP_LEN))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            SetSpecificLogCtrl(ucIdx, ucLogSwitch);
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;LogType: %s, LogSwitch: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, paLogTypeName[ucIdx],
</span></span><span style="display:flex;"><span>                   (<span style="color:#ae81ff">1</span><span style="color:#f92672">==</span>ucLogSwitch)<span style="color:#f92672">?</span><span style="color:#e6db74">&#34;On&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Off&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    OmciLogHelp();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="掩码表">掩码表
</h4><p>参见<a class="link" href="https://www.cnblogs.com/clover-toeic/p/3732444.html"  target="_blank" rel="noopener"
    >采用掩码方式简化产品国家地区支持能力的表示 - clover_toeic - 博客园</a>一文。该例实现中用到消息、掩码、函数指针等概念。</p>
<h2 id="编程思想">编程思想
</h2><p>表驱动法属于数据驱动编程的一种，其核心思想在《Unix编程艺术》和《代码大全2》中均有阐述。两者均认为人类阅读复杂数据结构远比复杂的控制流程容易，即<strong>相对于程序逻辑，人类更擅长于处理数据</strong>。本节将由Unix设计原则中的“分离原则”和“表示原则”展开。</p>
<blockquote>
<p><strong>分离原则：策略同机制分离，接口同引擎分离</strong></p>
</blockquote>
<p>机制即提供的功能；策略即如何使用功能。策略的变化要远远快于机制的变化。将两者分离，可以使机制相对保持稳定，而同时支持策略的变化。代码大全中提到“隔离变化”的概念，以及设计模式中提到的将易变化的部分和不易变化的部分分离也是这个思路。</p>
<blockquote>
<p><strong>表示原则：把知识叠入数据以求逻辑质朴而健壮</strong></p>
</blockquote>
<p>即使最简单的程序逻辑让人类来验证也很困难，但就算是很复杂的数据，对人类来说，还是相对容易推导和建模的。数据比编程逻辑更容易驾驭。在复杂数据和复杂代码中选择，宁可选择前者。更进一步，在设计中，应该主动将代码的复杂度转移到数据中去(参考“版本控制”)。</p>
<p>在“消息处理”示例中，每个消息处理的逻辑不变，但消息可能是变化的。将容易变化的消息和不容易变化的查找逻辑分离，即“隔离变化”。此外，该例也体现消息内部的处理逻辑(机制)和不同的消息处理(策略)分离。</p>
<p>数据驱动编程可以应用于：</p>
<ul>
<li>函数级设计，如本文示例。</li>
<li>程序级设计，如用表驱动法实现状态机。</li>
<li>系统级设计，如DSL。</li>
</ul>
<p>注意，数据驱动编程不是全新的编程模型，只是一种设计思路，在Unix/Linux开源社区应用很多。数据驱动编程中，数据不但表示某个对象的状态，实际上还定义程序的流程，这点不同于面向对象设计中的数据“封装”。</p>
<h2 id="附录">附录
</h2><h3 id="网友观点">网友观点
</h3><p>(以下观点摘自博客园网友“七心葵”的回帖，非常具有启发性。)</p>
<p>Booch的《面向对象分析与设计》一书中，提到所有的程序设计语言大概有3个源流：结构化编程、面向对象编程、数据驱动编程。我认为数据驱动编程的本质是“参数化抽象”的思想，不同于OO的“规范化抽象”的思想。</p>
<p>数据驱动编程在网络游戏开发过程中很常用，但是少有人专门提到这个词。数据驱动编程有很多名字：元编程，解释器/虚拟机，LOP/微语言/DSL等。包括声明式编程、标记语言、甚至所见即所得的拖放控件，都算是数据驱动编程的一种吧。</p>
<p>数据驱动编程可以帮助处理复杂性，和结构化编程、OO 均可相容。(正交的角度)将变和不变的部分分离，策略和机制分离，由此联想到的还有：(数据和代码的分离，微语言和解释器的分离，被生成代码和代码生成器的分离)；更近一步：(微内核插件式体系结构)。</p>
<p>元编程应该说是更加泛化的数据驱动编程，元编程不是新加入一个间接层，而是退居一步，使得当前的层变成一个间接层。元编程分为静态元编程(编译时)和动态元编程(运行时)，静态元编程本质上是一种代码生成技术或者编译器技术；动态元编程一般通过解释器(或虚拟机)加以实现。</p>
<p>数据驱动编程当然也不应该说是“反抽象的”，但的确与“OO抽象”的思维方式是迥然不同，泾渭分明的，如TAOUP一书中所述：“在Unix的模块化传统和围绕OO语言发展起来的使用模式之间，存在着紧张的对立关系”应该说数据驱动编程的思路与结构化编程和OO是正交的，更类似一种“跳出三界外，不在五行中”的做法。</p>
<h3 id="编程和人的关系">编程和人的关系
</h3><p>人类心智的限制，一切的背后都有人的因素作为依据：</p>
<ol>
<li>
<p>人同时关注的信息数量：7+-2 (所以要分模块)</p>
</li>
<li>
<p>人接收一组新信息的平均时间5s(所以要简单，系统总的模块数不要太多)</p>
</li>
<li>
<p>人思维的直观性(人的视觉能力和模糊思维能力)，这意味这两点：</p>
<ul>
<li>“直”——更善于思考自己能直接接触把玩的东西；(所以要“浅平透”、使用具象的设计，要尽量代码中只有顺直的流程);</li>
<li>“观”——更善于观图而不是推算逻辑；(所以要表驱动法，数据驱动编程，要UML，要可视化编程——当然MDA是太理想化了)</li>
</ul>
</li>
<li>
<p>人不能持续集中注意力(人在一定的代码行数中产生的bug数量的比例是一定的，所以语言有具有表现力，要体现表达的经济性)，所以要机制与策略分离，要数据和代码分离(数据驱动编程)，要微语言，要DSL，要LOP……</p>
</li>
<li>
<p>人是有创造欲，有现实利益心的(只要偶可能总是不够遵从规范，或想创造规范谋利——只要成本能承受，在硬件领域就不行)</p>
</li>
</ol>
<p>另外，开一个有意思的玩笑，Unix编程艺术艺术的英文缩写为TAOUP，我觉得可以理解为UP之TAO——向上抛出之道——将复杂的易变的逻辑作为数据或更高层代码抛给上层！</p>
<h3 id="函数指针">函数指针
</h3><p>“消息处理”一节示例中的函数指针有点插件结构的味道。可对这些插件进行方便替换，新增，删除，从而改变程序的行为。而这种改变，对事件处理函数的查找又是隔离的(隔离变化)。</p>
<p>函数指针非常有用，但使用时需注意其缺陷：无法检查参数(parameter)和返回值(return value)的类型。因为函数已经退化成指针，而指针不携带这些类型信息。缺少类型检查，当参数或返回值不一致时，可能会造成严重的错误。</p>
<p>例如，定义三个函数，分别具有两个参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">max</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y)  {  <span style="color:#66d9ef">return</span> x <span style="color:#f92672">&gt;</span> y <span style="color:#f92672">?</span> x : y;  }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">min</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y)  {  <span style="color:#66d9ef">return</span> x <span style="color:#f92672">&lt;</span> y <span style="color:#f92672">?</span> x: y;  }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y)  {  <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y;  }
</span></span></code></pre></div><p>而处理函数却定义为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">process</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y, <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>f)())  {  <span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>f)(x, y);  }
</span></span></code></pre></div><p>其中，第三个参数是一个没有参数且返回int型变量的函数指针。但后面却用 <code>process(a,b,max)</code>的方式进行调用，max带有两个参数。若编译器未检查出错误，而又不小心将 <code>return (*f)(x,y);</code>写成 <code>return (*f)(x);</code>，那么后果可能很严重。</p>
<p>因此在C语言中使用函数指针时，一定要小心<strong>类型陷阱</strong>。</p>
<hr>
<p>注：夹带一些私货，最近上下班会用耳机后台听tinyfool的一些视频，下面这个是关于学习曲线和规律的，启发比较大。如果要成为一个高手，需要在某个领域有一个合理的学习曲线（视频中所说的乐学者的学习曲线），认真练习和总结，持续学习，总会有所小成。因为这个讲座，最近开始阅读之前买了一直没看的《思考，快与慢》和《异类》这两本书，等读完了写个读书笔记。视频见下方</p>






    


<div class="video-wrapper">
    <iframe src="https://player.bilibili.com/player.html?as_wide=1&amp;high_quality=1&amp;page=1&bvid=BV1uU4y147Zi"
            scrolling="no"
            frameborder="no"
            framespacing="0"
            allowfullscreen="true"
    >
    </iframe>
</div>

<hr>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/c/c&#43;&#43;/">C/C&#43;&#43;</a>
        
            <a href="/tags/%E9%87%8D%E6%9E%84/">重构</a>
        
            <a href="/tags/%E8%AE%BE%E8%AE%A1/">设计</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%A4%BA/">
        
        

        <div class="article-details">
            <h2 class="article-title">浮点数在计算机中的表示</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "bugxch" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2016 - 
        
        2024 bugxch
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
